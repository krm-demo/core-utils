name: on-main-push
run-name: on-main-push into ${{ github.ref }} â„–${{ github.run_number }}

permissions:
  contents: write
  packages: write

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_call:  # <-- this YAML-mapping allows to invoke this workflow from internal/public releases
    inputs:
      release_type:
        type: string
        required: false
      release_phase:
        type: string
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ github.token }}
      GPG_KEY_ID: ${{ vars.GPG_KEY_ID }}
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}
      MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      MAVEN__CENTRAL_USERNAME: ${{ secrets.MAVEN__CENTRAL_USERNAME }}
      MAVEN__CENTRAL_PASSWORD: ${{ secrets.MAVEN__CENTRAL_PASSWORD }}

    steps:
      - name: "Checkout the 'main'-branch of repo '${{ github.ref }}' into './main-branch'"
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch
          fetch-depth: 0

      - name: "Set up JDK 25 (Amazon Corretto) - default maven-settings"
        uses: actions/setup-java@v4
        if: ${{ !inputs || inputs.release_type != 'PUBLIC' || inputs.release_phase != 'call-main' }}
        with:
          java-version: '25'
          distribution: 'corretto'
          check-latest: true
          cache: 'maven'
          cache-dependency-path: main-branch/pom.xml

      - name: "Set up JDK 25 (Amazon Corretto) - for PUBLIC-release (using Maven-Central as target)"
        uses: actions/setup-java@v4
        if: ${{ inputs && inputs.release_type == 'PUBLIC' && inputs.release_phase == 'call-main' }}
        with:
          java-version: '25'
          distribution: 'corretto'
          check-latest: true
          cache: 'maven'
          cache-dependency-path: main-branch/pom.xml
          server-id: maven-central
          server-username: MAVEN__CENTRAL_USERNAME
          server-password: MAVEN__CENTRAL_PASSWORD

      - name: "Dump effective maven-settings (show passwords)"
        run: |
          # save the effective-settings into './target/effective-settings--show-psw.xml':
          mvn help:effective-settings -DshowPasswords=true -Doutput=./target/effective-settings--show-psw.xml
          # print the effective-settings (with show passwords) in summary:
          echo "<details><summary><code>effective-settings--show-psw.xml</code></summary>" >> $GITHUB_STEP_SUMMARY
          echo -e "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`xml" >> $GITHUB_STEP_SUMMARY
          cat ./target/effective-settings--show-psw.xml >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo -e "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

      - name: "Dump effective maven-settings (hide passwords)"
        run: |
          # save the effective-settings into './target/effective-settings.xml':
          mvn help:effective-settings -Doutput=./target/effective-settings.xml
          # print the effective-settings (with hide passwords) in summary:
          echo "<details><summary><code>effective-settings.xml</code></summary>" >> $GITHUB_STEP_SUMMARY
          echo -e "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`xml" >> $GITHUB_STEP_SUMMARY
          cat ./target/effective-settings.xml >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
          echo -e "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

      - name: "Dump Git-Hub context-variables into '.github/th-vars'-dir"
        run: |
          # dump the value of Git-Hub context-variables
          cd main-branch
          echo '${{ toJson(github) }}' > .github/th-vars/var-github.json
          echo '${{ toJson(inputs) }}' > .github/th-vars/var-githubInputs.json
          echo '${{ toJson(job) }}' > .github/th-vars/var-githubJob.json
          echo '${{ toJson(steps) }}' > .github/th-vars/var-githubSteps.json
          echo '${{ toJson(secrets)  }}' > .github/th-vars/var-secrets.json
          echo '${{ toJson(vars)  }}' > .github/th-vars/var-githubVars.json
          echo "~~~~~~~~~~~~~ ( dump the content of cotext-variables into summary ) ~~~~~~~~~~~~~"
          .github/th-vars/dump-to-summary-sections.sh

      - name: "Perform the build and install using 'Apache Maven'"
        run: |
          # build and install to local maven repository
          cd main-branch
          echo "Current directory is $(pwd)"

          # echo "~~~~~~~~~~~~~ ( generate 'Release Catalog' root ) ~~~~~~~~~~~~~"
          # mvn -B --quiet test-compile
          # .github/th-tool.sh process .github/th-templates/GH-PAGES--Release-Catalog.html.th --output target/GH-PAGES--Release-Catalog.html
          # cat target/GH-PAGES--Release-Catalog.html

          echo "~~~~~~~~~~~~~ ( execute the default-lifecycle of the build up to 'install' phase ) ~~~~~~~~~~~~~"
          mvn -B install

          echo "~~~~~~~~~~~~~ ( execute integration tests, that require some results from main lifecycle ) ~~~~~~~~~~~~~"
          mvn -B failsafe:integration-test
          
          echo "~~~~~~~~~~~~~ ( dump the content of './target/' into summary ) ~~~~~~~~~~~~~"
          echo "
          the result of maven-build (content of \`./target/\` directory):
          \`\`\`bash
          $(ls -laxo ./target)
          \`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "~~~~~~~~~~~~~ ( execute the 'sign-and-deploy-to-dir.sh' ) ~~~~~~~~~~~~~"
          .github/scripts/deploy/sign-and-deploy-to-dir.sh

          echo "~~~~~~~~~~~~~ ( dump the hierarchy of deploying bundle ) ~~~~~~~~~~~~~"
          echo "
          the result of \`sign-and-deploy-to-dir.sh\` (hierarchy of \`./target/deploy-dir--maven-central\` directory):
          \`\`\`bash
          $(tree ./target/deploy-dir--maven-central)
          \`\`\`" >> $GITHUB_STEP_SUMMARY

      # Following step is for INTERNAL-release phase(1)
      - name: "Perform the deployment into Git-Hub Artifactory"
        if: ${{ inputs && inputs.release_type == 'INTERNAL' && inputs.release_phase == 'call-main'}}
        run: |
          echo "--- deployment to GitHub Artifactory: ---"
          cd main-branch

          echo "~~~~~~~~~~~~~ ( dump the content of './target/' into summary before 'deploy-github-packages.sh' ) ~~~~~~~~~~~~~"
          echo "
          the content of \`./target/\` directory before executing \`...deploy-github-packages.sh\`:
          \`\`\`bash
          $(ls -laxo ./target)
          \`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          
          #echo "~~~~~~~~~~~~~ ( executing 'deploy-github-packages.sh' ) ~~~~~~~~~~~~~"
          #.github/scripts/deploy/deploy-github-packages.sh

          #echo "~~~~~~~~~~~~~ ( executing 'gpg-import.sh' ) ~~~~~~~~~~~~~"
          .github/gpg/gpg-import.sh

          #echo "~~~~~~~~~~~~~ ( executing 'sign-and-deploy-github-packages.sh' ) ~~~~~~~~~~~~~"
          .github/scripts/deploy/sign-and-deploy-github-packages.sh

          echo "---" >> $GITHUB_STEP_SUMMARY

          # Process the template '.github/th-templates/Usage-INTERNAL.md.th' via 'th-tool':
          .github/th-tool.sh process .github/th-templates/Usage-INTERNAL.md.th --output $RUNNER_TEMP/Usage-INTERNAL.md
          cat $RUNNER_TEMP/Usage-INTERNAL.md >> $GITHUB_STEP_SUMMARY

      # Following step is for PUBLIC-release phase(1)
      - name: "Perform the deployment into Maven-Central Artifactory"
        if: ${{ inputs && inputs.release_type == 'PUBLIC' && inputs.release_phase == 'call-main'}}
        run: |
          echo "--- deployment to Maven-Central Artifactory: ---"
          cd main-branch

          echo "~~~~~~~~~~~~~ ( dump the content of './target/' into summary before 'sign-and-deploy-maven-central.sh' ) ~~~~~~~~~~~~~"
          echo "
          the content of \`./target/\` directory before executing \`...sign-and-deploy-maven-central.sh\`:
          \`\`\`bash
          $(ls -laxo ./target)
          \`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY

          #echo "~~~~~~~~~~~~~ ( executing 'gpg-import.sh' ) ~~~~~~~~~~~~~"
          .github/gpg/gpg-import.sh

          #echo "~~~~~~~~~~~~~ ( executing 'sign-and-deploy-maven-central.sh' ) ~~~~~~~~~~~~~"
          .github/scripts/deploy/sign-and-deploy-maven-central.sh

          echo "---" >> $GITHUB_STEP_SUMMARY
          
          # Process the template '.github/th-templates/Usage-PUBLIC.md.th' via 'th-tool':
          .github/th-tool.sh process .github/th-templates/Usage-PUBLIC.md.th --output $RUNNER_TEMP/Usage-PUBLIC.md
          cat $RUNNER_TEMP/Usage-PUBLIC.md >> $GITHUB_STEP_SUMMARY

      # Following step is for phase(2) of both INTERNAL-release and PUBLIC-release
      - name: "Inform the developers that new SNAPSHOT-version is available"
        if: ${{ inputs && inputs.release_phase == 'call-main-next'}}
        run: |
          echo "--- handle the phase when new SNAPSHOT-version is created: ---"
          cd main-branch
          # Process the template '.github/th-templates/Usage-SNAPSHOT.md.th' via 'th-tool':
          .github/th-tool.sh process .github/th-templates/Usage-SNAPSHOT.md.th --output $GITHUB_STEP_SUMMARY

      # Following step is for regular commit/push (absence of 'inputs.release_type' implies that):
      - name: "Specific actions for regular commits (most probably nothing)"
        if: ${{ inputs.release_type != 'INTERNAL' && inputs.release_type != 'PUBLIC' }}
        run: |
          echo "--- this is a regular commit, that is not related to any releases ---"
          cd main-branch
          # Process the template '.github/th-templates/Usage-SNAPSHOT.md.th' via 'th-tool':
          .github/th-tool.sh process .github/th-templates/Usage-SNAPSHOT.md.th --output $GITHUB_STEP_SUMMARY

      - name: "Checkout the 'gh-pages'-branch of repo '${{ github.ref }}' into './gh-pages-branch'"
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-branch
          fetch-depth: 0

      - name: "Copy the result of 'javadoc' MOJOs and update 'Release Catalog'"
        run: |
          cd main-branch
          git log --oneline > ../gh-pages-branch/git-log.txt
          echo "the content of git log is $(wc --lines --bytes ../gh-pages-branch/git-log.txt)"

          # going to extract the file-slug (basename without extension) of a target JAR-file
          # and use it as a name of the destination directory to copy the generated Java-Doc
          JAR_FILE_NAME=$(find "./target/" -mindepth 1 -maxdepth 1 -name "*.jar" ! -name "*-javadoc*.jar" ! -name "*-sources*.jar" -exec basename {} \;)
          echo "... going to re-write the content of folder '$(realpath ../gh-pages-branch/${JAR_FILE_NAME%.*})': ..."
          rm -rf ../gh-pages-branch/*-SNAPSHOT
          echo "JAR_FILE_NAME=$JAR_FILE_NAME"
          
          echo "... process generated JavaDoc-report with 'th-tool' (and output it as the project-site): ..."
          .github/th-tool.sh process-dir --input-dir target/reports/apidocs/ --output-dir ../gh-pages-branch/${JAR_FILE_NAME%.*} .html

          echo "... copy the 'test-site' that was generated in scope of 'mvn test -Dtest=ThymeleafToolTest#testProcessDir_TestSite': ..."
          cp -r .github/th-test-site ../gh-pages-branch/${JAR_FILE_NAME%.*}

          echo "... copy the test-results from 'Open-Test-4j' (MOJO 'mvn exec:java@open-test-report') ..."
          cp -r target/open-test-report.* ../gh-pages-branch/${JAR_FILE_NAME%.*}

          echo "... copy the test-coverage-report from 'JaCoCo' (MOJO 'mvn jacoco:report') ..."
          cp -r target/jacoco-reports ../gh-pages-branch/${JAR_FILE_NAME%.*}

          echo "... copy the previously generated 'Release Catalog' page ..."
          cp -r .github/th-release-catalog/* ../gh-pages-branch

          #tree -L 2 ../gh-pages-branch
          ls -laxo ../gh-pages-branch

      - name: "Commit and push the content 'gh-pages-branch' (together with some test text-files)"
        run: |
          # build and install to local maven repository
          echo "created by GitHub-Workflow '$GITHUB_WORKFLOW' action #$GITHUB_RUN_NUMBER with '${{ inputs.release_type }}/${{ inputs.release_phase }}' at $(date)" >> gh-pages-branch/a.txt
          cd gh-pages-branch
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .
          git commit -m "add the test text-file a.txt as a result of GitHub-Workflow '$GITHUB_WORKFLOW' #$GITHUB_RUN_NUMBER with '${{ inputs.release_type }}/${{ inputs.release_phase }}'"
          git push
          echo "That's it "'!!!'

name: th-tool
run-name: ${{ github.actor }} has executed 'misc--th-tool.yml' â„–${{ github.run_number }}
on: workflow_dispatch

# Note! The multiple execution of "th-tool" slow down the execution of this workflow considerably...
# So, it's recommended to process a single th-template instead of multiple call to "th-tool.sh eval ..."

jobs:
  th-tool:
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout the latest version of repo in '${{ github.ref }}'"
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: "Set up JDK 25 (Amazon Corretto)"
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'corretto'
          check-latest: true
          cache: 'maven'
          cache-dependency-path: pom.xml

      - name: "Setup JBang"
        uses: jbangdev/setup-jbang@main
      - run: jbang properties@jbangdev 'java.v' 'java.r' 'java.s' 'sun.*' 'user.*'

      - name: "Dump Environment-Variables into '.github/th-vars'-dir"
        run: |
          # dump the output of './src/scripts/jbang/DumpEnvVars.java' into JSON-file
          # jbang --quiet src/scripts/jbang/DumpEnvVars.java
          jbang --quiet src/scripts/jbang/DumpEnvVars.java > .github/th-vars/var-envVars.json

      - name: "Dump Java System-Properties into '.github/th-vars'-dir"
        run: |
          # dump the output of './src/scripts/jbang/DumpSysProps.java' into JSON-file
          # jbang --quiet src/scripts/jbang/DumpSysProps.java
          jbang --quiet src/scripts/jbang/DumpSysProps.java > .github/th-vars/var-sysProps.json

      - name: "Dump Git-Hub context into '.github/th-vars'-dir"
        run: |
          # dump the value of {{ github }} into JSON-file
          echo '${{ toJson(github) }}' > .github/th-vars/var-github.json

      - name: "Dump 'secrets' context into '.github/th-vars'-dir"
        run: |
          # dump the value of {{ secrets }} into JSON-file
          echo '${{ toJson(secrets) }}' > .github/th-vars/var-secrets.json

      - name: "Compile 'th-tool' (no tests and no JARs and JavaDoc):"
        run: mvn test-compile

      - name: "Examples of simple expressions by 'th-tool':"
        run: |
          .github/th-tool.sh eval 1+2 \* 3+4 \* 5 --output ./target/expr-result-00.txt
          .github/th-tool.sh eval xxx.get$'\'("property-one")\'' --output ./target/expr-result-01.txt
          .github/th-tool.sh eval xxx$'\'["property-num"]\'' --output ./target/expr-result-02.txt
          .github/th-tool.sh eval $'\'"la-la-la"\'' --output ./target/expr-result-03.txt
          .github/th-tool.sh eval $'\'"la-la-la  1212   456 7\nthe second line"\'' --output ./target/expr-result-04.txt

          echo "---" >> $GITHUB_STEP_SUMMARY

          echo "#### some simple expressions:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "1+2 * 3+4 * 5 = $(cat ./target/expr-result-00.txt)" >> $GITHUB_STEP_SUMMARY
          echo "xxx.property-one = $(cat ./target/expr-result-01.txt)" >> $GITHUB_STEP_SUMMARY
          echo "xxx.property-num = $(cat ./target/expr-result-02.txt)" >> $GITHUB_STEP_SUMMARY
          echo "\"la-la-la\" = $(cat ./target/expr-result-03.txt)" >> $GITHUB_STEP_SUMMARY
          echo -e "\necho \"la-la-la  1212   456 7\nthe second line\":\n$(cat ./target/expr-result-04.txt)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: "Examples of maven-versions expressions by 'th-tool' with 'mh'-helper:"
        run: |
          echo "#### Values of current, release and next versions (by 'mh'-helper):" >> $GITHUB_STEP_SUMMARY
          echo "| th-tool eval \`...\` | Value | Description |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| \`mh.projectArtifact\` | \`$(.github/th-tool.sh eval mh.projectArtifact)\` | The name of the project artifact in \`pom.xml\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`mh.currentProjectVersion\` | \`$(.github/th-tool.sh eval mh.currentProjectVersion)\` | Current version of project in \`pom.xml\` |" >> $GITHUB_STEP_SUMMARY
          echo "| \`mh.calculatedProjectVersion\` | \`$(.github/th-tool.sh eval mh.calculatedProjectVersion)\` | Current version, but calculated from parts |" >> $GITHUB_STEP_SUMMARY
          echo "| \`mh.internalReleaseVersion\` | \`$(.github/th-tool.sh eval mh.internalReleaseVersion)\` | The version of next **internal release** |" >> $GITHUB_STEP_SUMMARY
          echo "| \`mh.internalNextVersion\` | \`$(.github/th-tool.sh eval mh.internalNextVersion)\` | The next development version **after internal release**|" >> $GITHUB_STEP_SUMMARY
          echo "| \`mh.publicReleaseVersion\` | \`$(.github/th-tool.sh eval mh.publicReleaseVersion)\` | The version of next **public release**|" >> $GITHUB_STEP_SUMMARY
          echo "| \`mh.publicNextVersion\` | \`$(.github/th-tool.sh eval mh.publicNextVersion)\` | The next development version **after public release**|" >> $GITHUB_STEP_SUMMARY

      - name: "Process the template '.github/th-templates/Usage-SNAPSHOT.md.th' via 'th-tool':"
        run: .github/th-tool.sh process .github/th-templates/Usage-SNAPSHOT.md.th --output $GITHUB_STEP_SUMMARY

      - name: "Process the template '.github/th-templates/Usage-INTERNAL.md.th' via 'th-tool':"
        run: .github/th-tool.sh process .github/th-templates/Usage-INTERNAL.md.th --output $GITHUB_STEP_SUMMARY

      - name: "Process the template '.github/th-templates/Usage-PUBLIC.md.th' via 'th-tool':"
        run: .github/th-tool.sh process .github/th-templates/Usage-PUBLIC.md.th --output $GITHUB_STEP_SUMMARY


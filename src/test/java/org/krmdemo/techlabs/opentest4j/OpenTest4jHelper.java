package org.krmdemo.techlabs.opentest4j;

import com.fasterxml.jackson.annotation.JsonPropertyOrder;
import lombok.Getter;
import org.krmdemo.techlabs.core.dump.DumpUtils;
import org.krmdemo.techlabs.thtool.ThymeleafTool;
import org.krmdemo.techlabs.thtool.ThymeleafToolCtx;
import org.krmdemo.techlabs.thtool.badges.BadgeVersionProvider;
import org.krmdemo.techlabs.thtool.helpers.GithubBadgeHelper;
import org.krmdemo.techlabs.thtool.helpers.GithubHelper;
import org.krmdemo.techlabs.thtool.helpers.MavenHelper;
import org.opentest4j.reporting.tooling.core.htmlreport.DefaultHtmlReportWriter;

import java.nio.file.Path;
import java.util.Objects;
import java.util.function.Consumer;

/**
 * This class represents a <b>{@code th-tool}</b>-helper to work with the result of executing JUnit-tests
 * in a way provided by <a href="https://github.com/ota4j-team">Open Test Alliance for the JVM</a>.
 * The properties of this helper are available from <b>{@code th-tool}</b>-templates by name {@code openTest4j}.
 */
@JsonPropertyOrder(alphabetic = true)
public class OpenTest4jHelper {

    /**
     * The name of <b>{@code th-tool}</b>-variable for helper-object {@link OpenTest4jHelper}
     */
    public static final String VAR_NAME__HELPER = "openTest4j";

    /**
     * @param ttCtx <b>{@code th-tool}</b>-context to wrap
     * @return an instance of {@link OpenTest4jHelper} for unit-tests
     */
    public static OpenTest4jHelper fromCtxLazy(ThymeleafToolCtx ttCtx) {
        OpenTest4jHelper helper = fromCtx(ttCtx);
        if (helper == null) {
            OpenTest4jHelper.register(ttCtx);
            GithubBadgeHelper.register(ttCtx);
            GithubHelper.register(ttCtx);
            MavenHelper.register(ttCtx);
            helper = fromCtx(ttCtx);
        }
        return helper;
    }

    /**
     * A factory-method that returns an instance of {@link GithubBadgeHelper}
     * that was previously registered with {@link #register(ThymeleafToolCtx)}.
     *
     * @param ttCtx <b>{@code th-tool}</b>-context to wrap
     * @return an instance of {@link OpenTest4jHelper} for access from other helpers
     */
    public static OpenTest4jHelper fromCtx(ThymeleafToolCtx ttCtx) {
        return ttCtx.typedVar(VAR_NAME__HELPER, OpenTest4jHelper.class);
    }

    /**
     * Context-registering method of functional type {@link Consumer Consumer&lt;ThymeleafToolCtx&gt;}.
     * Should be used when initializing the instance of {@link ThymeleafTool},
     * which allows to decouple the dependencies between <b>{@code th-tool}</b> and helper-objects.
     *
     * @param ttCtx <b>{@code th-tool}</b>-context to register this helper in
     */
    public static void register(ThymeleafToolCtx ttCtx) {
        OpenTest4jHelper helper = new OpenTest4jHelper(ttCtx);
        ttCtx.setVariable(VAR_NAME__HELPER, helper);
    }

    private final ThymeleafToolCtx ttCtx;
    private OpenTest4jHelper(ThymeleafToolCtx ttCtx) {
        this.ttCtx = Objects.requireNonNull(ttCtx);
    }

    // --------------------------------------------------------------------------------------------

    /**
     * An instance of {@link BadgeVersionProvider} that provides the badges
     * to the test-report that was generated by {@link DefaultHtmlReportWriter opentest4j-library}
     * <hr/>
     * TODO: display some stats about tests at least in tooltip
     * <hr/>
     * HTML-badges are inserted via following th-inlines: {@snippet :
     *     [(${ openTest4j.bp.of(minorGroup).badgeHtml })]
     *     [(${ openTest4j.bp.badgeHtml(minorGroup) })]
     * }
     * 'GitHib Markdown'-badges are inserted via following th-inlines: {@snippet :
     *     [(${ openTest4j.bp.of(minorGroup).badgeMD })]
     *     [(${ openTest4j.bp.badgeMD(minorGroup) })]
     * }
     * <hr/>
     * HTML-badge for root is inserted via following th-inline: {@snippet :
     *     [(${ openTest4j.bp.root.badgeHtml })]
     * }
     * 'GitHib Markdown'-badge for root are inserted via following th-inline: {@snippet :
     *     [(${ openTest4j.bp.root.badgeMD })]
     * }
     */
    @Getter
    private final BadgeVersionProvider bp = new BadgeVersionProvider.FuncRec(
        this::badgeImageUrl,
        this::badgeTargetUrl,
        (String _versionStr) -> "Open-Test-4j report",
        (String _versionStr) -> "Open-Test-4j report"
    );

    /**
     * @param _versionStr unused here
     * @return the URL to the badge-image for the test-results report
     *         that was generated by {@link DefaultHtmlReportWriter opentest4j-library}
     */
    public String badgeImageUrl(String _versionStr) {
        GithubBadgeHelper gbh = GithubBadgeHelper.fromCtx(ttCtx);
        return gbh.badgeUrlShiedsIO("test-results", "Open-Test-4j", "blue",
            //"b0e0e6", // <-- this color is called "PowderBlue" at https://htmlcolorcodes.com/color-names/
            Path.of(".github/images/opentest4j/opentest4j-logo--48.png").toFile(),
            "f8981d", // <-- this color corresponds "--selected-background-color" CSS-variable at JavDoc-site
            "4D7A97" // <-- this color corresponds "--navbar-background-color" CSS-variable at JavDoc-site
        );
    }

    /**
     * @param _versionStr unused here
     * @return a target URL to the test-results report
     *         that was generated by {@link DefaultHtmlReportWriter opentest4j-library}
     */
    public String badgeTargetUrl(String _versionStr) {
        // TODO: think about using "MavenHelper.getProjectCatalogName()"
        return String.format("https://krm-demo.github.io/core-utils/%s-%s/open-test-report.html",
            GithubHelper.fromCtx(ttCtx).getRepoName(),
            MavenHelper.fromCtx(ttCtx).getCurrentProjectVersion());
    }

    // --------------------------------------------------------------------------------------------

    /**
     * @return HTML-fragment with link to declaration of MOJO that executes <b>{@code openTest4j}</b> reports
     */
    public String getALinkToMavenExecInPom() {
        return String.format("""
            <a href="%s/%s"><code>pom.xml</code>-file</a>""",
            GithubBadgeHelper.fromCtx(ttCtx).getGitHubCurrentRootUrl(),
            "pom.xml#L607-L631");
    }

    /**
     * @return HTML-fragment with link to JUnit properties-file which forces corresponding XML-report to be created
     */
    public String getALinkToJUnitProps() {
        return String.format("""
            <a href="%s/%s"><code>JUnit-Platform</code>-properties</a>""",
            GithubBadgeHelper.fromCtx(ttCtx).getGitHubCurrentRootUrl(),
            "src/test/resources/junit-platform.properties#L1-L2");
    }

    @Override
    public String toString() {
        return DumpUtils.dumpAsJsonTxt(this);
    }
}
